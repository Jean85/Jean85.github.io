<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Adding Event Sourcing to an existing PHP project (for the right reasons)</title>
    <meta name="description" content="Talk about a case history in integrating an event sourcing system for reports; presented at PHPDay 2018, May 12th 2018">
    <meta name="author" content="Alessandro Lai">

    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/beige.css">
    <link type="image/x-icon" rel="shortcut icon" href="img/favicon.ico"/>

    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="css/fixes.css">
    <link rel="stylesheet" href="lib/css/highlight-js/idea.css">
    <!-- FontAwesome -->
    <script defer src="lib/font/fontawesome-free-5.11.2-web/js/all.js"></script>
    <!-- Printing and PDF exports -->
    <script>
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = window.location.search.match(/print-pdf/gi) ? 'css/print/pdf.css' : 'css/print/paper.css';
        document.getElementsByTagName('head')[0].appendChild(link);
    </script>
</head>
<body>
<div class="reveal">
    <img id="logo-engineering" src="img/logo_engineering.png">
    <img id="logo-sfcon" src="img/logo_sfcon_amsterdam2019.png" />
    <div class="slides">
        <section id="title">
            <h1 style="font-size: 3em">
                Adding Event Sourcing <br>
                to an existing PHP project
            </h1>
            <h4>(for the right reasons)</h4>
            <p>
                <a href="https://alessandrolai.dev/">Alessandro Lai</a> / <a href="http://twitter.com/AlessandroLai">@AlessandroLai</a><br>
            </p>
            <small>
                <p>
                    <a href="https://amsterdam2019.symfony.com/speakers">SymfonyCon 2019</a> - November 21st-22nd 2019,
                    Amsterdam
                </p>
            </small>
        </section>

        <section id="intro">
            <section>
                <h2>Who am I?</h2>
                <img src="img/github_avatar.jpg" class="avatar stretch">
                <div style="float: right">
                    <ul class="fa-ul">
                        <li><span class="fa-li"><i class="fas fa-user"></i></span>Alessandro Lai</li>
                        <li>
                            <span class="fa-li"><i class="fas fa-desktop"></i></span>
                            Project lead @ <img src="img/logo_engineering_full.png"
                                                style="height: 1.6em; box-shadow: none; vertical-align: middle; margin-bottom: 0; margin-top: -0.8em">
                        </li>
                        <li>
                            <span class="fa-li"><i class="fab fa-github"></i></span>
                            <a href="https://github.com/Jean85">@Jean85</a>
                        </li>
                        <li>
                            <span class="fa-li"><i class="fab fa-twitter"></i></span>
                            <a href="https://twitter.com/AlessandroLai">@AlessandroLai</a>
                        </li>
                        <li>
                            <span class="fa-li"><i class="fas fa-users"></i></span>
                            PHP UG Milan Coordinator
                        </li>
                        <li>
                            <span class="fa-li fa-layers">
                                <i class="fas fa-certificate"></i>
                                <i class="fas fa-inverse fa-check" data-fa-transform="shrink-8"></i>
                            </span>
                            PHP-FIG Secretary
                        </li>
                    </ul>
                </div>
            </section>

            <section>
                <h2>What is this talk about?</h2>
                <aside class="notes">
                    <ul class="fa-ul">
                        <li>
                            It's a case history
                        </li>
                        <li>
                            Just a brief theory explanation
                        </li>
                        <li>
                            We bent the state of the art to our use case
                        </li>
                        <li>
                            We'll see practical implementation details!
                        </li>
                    </ul>
                </aside>
            </section>

            <section class="white" data-background-image="img/shark-team.jpg">
                <h2>
                    <br>
                    <br>
                    <br>
                    Disclaimer 0:<br>
                </h2>
                <h2>It's a group effort!</h2>
                <h3>The Facile.it Shark team</h3>
            </section>

            <section>
                <h2>Disclaimer 1:</h2>
                <img src="img/gabriele-lana.jpg" class="avatar stretch" style="float: left">
                <h3>We got help!</h3>
                <div>
                    We reached out to <a href="https://twitter.com/gabrielelana">@gabrielelana</a><br>
                    for a speedy bootstrap with <br>
                    MongoDB + Event Sourcing
                </div>
            </section>
        </section>

        <section id="theory">
            <section>
                <h2>First things first:</h2>
                <p>What's Event Sourcing?</p>
                <aside class="notes">
                    <strong style="font-size: larger">02:24</strong>
                </aside>
            </section>

            <section data-background-image="img/money.jpg" data-transition="none">
                <div class="stretch">
                    <div class="credit white"><a href="https://flic.kr/p/6c6Q6r">https://flic.kr/p/6c6Q6r</a></div>
                </div>
            </section>

            <section>
                <h2>The prime example:</h2>
                <h3>Money transactions, without events...</h3>
                <aside class="notes">
                    <ul>
                        <li>
                            You save only the current state (the balance)
                        </li>
                        <li>
                            Each operation completely rewrites the information
                        </li>
                        <li>
                            What about concurrency???
                        </li>
                        <li>
                            We are addicted to software transactions, but they are inherently fallible
                        </li>
                    </ul>
                </aside>
            </section>

            <section>
                <h2>With events, instead...</h2>
                <aside class="notes">
                    <ul>
                        <li>
                            We store performed actions <br>
                            <span class="smaller">(withdrawal, deposit)</span>
                        </li>
                        <li>
                            Concurrency is no longer a big issue<br>
                            <span class="smaller">(negative balance)</span>
                        </li>
                        <li>
                            Aggregating events gives me the current state<br>
                            <span class="smaller">(current balance)</span>
                        </li>
                    </ul>
                </aside>
            </section>

            <section>
                <h2>And CQRS?</h2>
                <p>
                    It's normally opposed to CRUD,<br>
                    see <a href="https://martinfowler.com/bliki/CQRS.html">Martin Fowler's article</a>
                </p>
                <p>It's a design pattern, it stands for:</p>
                <ul>
                    <li><b>C</b>ommand <span class="fragment grey">(write)</span></li>
                    <li><b>Q</b>uery <span class="fragment grey">(read)</span></li>
                    <li><b>R</b>esponsibility</li>
                    <li><b>S</b>egregation</li>
                </ul>
            </section>
        </section>

        <section id="setup">
            <section>
                <h2>Story time!</h2>
                <aside class="notes">
                    <strong style="font-size: larger">06:33</strong>
                </aside>
            </section>
            <section data-background-image="img/star-wars-intro.jpg" data-transition="none">
                <div class="stretch">
                    <div class="credit white"><a href="https://flic.kr/p/SuqTZG">https://flic.kr/p/SuqTZG</a></div>
                </div>
            </section>
            <section data-background-image="img/greenfield.jpg" data-transition="none">
                <div class="stretch">
                    <div class="credit white"><a href="https://flic.kr/p/rVrVkv">https://flic.kr/p/rVrVkv</a></div>
                </div>
            </section>
            <section data-background-image="img/legacy-project.jpg" data-transition="none">
                <div class="stretch">
                    <div class="credit white"><a href="https://flic.kr/p/VAU3d">https://flic.kr/p/VAU3d</a></div>
                </div>
            </section>
            <section>
                <h2>In the real world...</h2>
                <ul class="fa-ul">
                    <li>
                        <span class="fa-li"><i class="fas fa-times"></i></span>
                        Adding event sourcing from the beginning is costly
                    </li>
                    <li>
                        <span class="fa-li"><i class="fas fa-cogs"></i></span>
                        Business complexity comes only with time
                    </li>
                </ul>
                <aside class="notes">
                    <ul>
                        <li>
                            Projects start small and simple
                        </li>
                        <li>
                            Adding event sourcing from the beginning is costly
                        </li>
                        <li>
                            Especially with PHP, a fast CRUD approach <br> is used 99% of the time
                        </li>
                        <li>
                            Inherent business complexity comes only with time, while adding new features
                        </li>
                    </ul>
                </aside>
            </section>
        </section>

        <section id="our-use-case">
            <section>
                <h2>Project Background</h2>
                <aside class="notes">
                    <strong style="font-size: larger">08:37</strong>
                </aside>
            </section>
            <section>
                <h2>Our use case</h2>
                <ul class="fa-ul">
                    <li>
                        <span class="fa-li"><i class="fa fa-users"></i></span>
                        The Shark team works on the <br>
                        Facile Partner Network (FPN) project
                    </li>
                    <li>
                        <span class="fa-li"><i class="fa fa-handshake"></i></span>
                        It's a B2B platform for car insurance brokering
                    </li>
                    <li>
                        <span class="fa-li"><i class="fa fa-desktop"></i></span>
                        We offer the platform to insurance agents <br>
                        that already have their own physical business
                    </li>
                </ul>
            </section>
            <section>
                <h2>Complex domain</h2>
                <ul class="fa-ul">
                    <li>
                        <span class="fa-li"><i class="fa fa-hourglass-end"></i></span>
                        The project is 8+ years old (started from SF1)
                    </li>
                    <li>
                        <span class="fa-li"><i class="fa fa-reply-all"></i></span>
                        We handle the product after it's sold
                    </li>
                    <li>
                        <span class="fa-li"><i class="fab fa-usb"></i></span>
                        We have to be an adapter for a lot of processes
                    </li>
                </ul>
            </section>
            <section>
                <h2>Our issues</h2>
                <ul class="fa-ul">
                    <li>
                        <span class="fa-li"><i class="fa fa-tasks"></i></span>
                        Business rules evolve really fast!
                    </li>
                    <li>
                        <span class="fa-li"><i class="fa fa-chart-bar"></i></span>
                        New reports are requested often
                    </li>
                </ul>
                <aside class="notes">
                    <ul>
                        <li>
                            We still have to provide historical data
                        </li>
                        <li>
                            We also had a small piece of functionality<br>
                            that was having growing pains inside our RDBMS
                            <div class="smaller">(MySQL + Doctrine)</div>
                        </li>
                    </ul>
                </aside>
            </section>
            <section>
                <h2>Our solutions</h2>
                <ol>
                    <li>Gabriele</li>
                    <li>MongoDB</li>
                    <li>Event sourcing</li>
                </ol>
            </section>
        </section>

        <section id="events-explained">
            <section>
                <h2>Events in practice</h2>
                <aside class="notes">
                    <strong style="font-size: larger">12:28</strong>
                </aside>
            </section>
            <section>
                <h2>Anatomy of an event</h2>
                <div>
                    An event is just a document with some properties
                    <br>&nbsp;
                </div>
                <ul class="fa-ul">
                    <li><span class="fa-li"><i class="fa fa-long-arrow-alt-right"></i></span>Type</li>
                    <li><span class="fa-li"><i class="fa fa-long-arrow-alt-right"></i></span>Family</li>
                    <li><span class="fa-li"><i class="fa fa-long-arrow-alt-right"></i></span>Payload</li>
                    <li><span class="fa-li"><i class="fa fa-long-arrow-alt-right"></i></span>Metadata</li>
                </ul>
            </section>
            <section>
						<pre class="stretch"><code data-trim data-noescape>{
    "_id" : ObjectId("5898ab5a22c92d69123f7281"),
    "type" : "agendaCreated",
    "eventFamily" : "agenda",
    "meta" : {
        "createdAt" : ISODate("2017-02-06T17:59:05"),
        "receivedAt" : ISODate("2017-02-06T17:59:06"),
        "currentUserId" : 29877,
        "taskId" : 3503425,
        "productId" : 5937725,
        ... 
    },
    "payload" : {
        "currentUser" : {
            "id" : 29877,
            ...
        },
        "task" : {
            "id" : 3503425,
            ...
        },
        "product" : {
            "id" : 5937725,
            ...
        }
        ...
    }
}
						</code></pre>
            </section>
            <section>
                <h2>Event fields</h2>
                <ul class="fa-ul">
                    <li>
                        <span class="fa-li"><i class="fa fa-long-arrow-alt-right"></i></span>
                        <b>Type</b>: event name
                    </li>
                    <li>
                        <span class="fa-li"><i class="fa fa-long-arrow-alt-right"></i></span>
                        <b>Family</b>: generic event grouping
                    </li>
                    <li>
                        <span class="fa-li"><i class="fa fa-long-arrow-alt-right"></i></span>
                        <b>Metadata</b>: generic event info, <code>createdAt</code>
                    </li>
                    <li>
                        <span class="fa-li"><i class="fa fa-long-arrow-alt-right"></i></span>
                        <b>Payload</b>: event informations
                    </li>
                </ul>
                <aside class="notes">
                    <ul>
                        <li>
                            Family is a more generic grouping
                            <div class="smaller">(depends on business domain)</div>
                        </li>
                        <li>
                            Family, metadata are helpful for searching/filtering: <br>
                            you normally work with a specific list of (ordered) events
                        </li>
                        <li>
                            Indexes are a must, at least on <code>createdAt</code>
                        </li>
                        <li>
                            We can also use metadata to store system info<br>
                            <small>(user, origin, application...)</small>
                        </li>
                        <li>
                            Remember, events are always in the past
                        </li>
                        <li>
                            How many things should I put in there?<br>
                            "When in doubt, do not omit"
                        </li>
                    </ul>
                </aside>
            </section>
        </section>

        <section id="event-storing">
            <section>
                <h2>Storing events</h2>
                <ul class="fa-ul">
                    <li>
                        <span class="fa-li"><i class="fa fa-bullhorn"></i></span>
                        Symfony Event Dispatcher
                    </li>
                    <li>
                        <span class="fa-li"><i class="fa fa-tasks"></i></span>
                        Base event + decorators
                    </li>
                    <li>
                        <span class="fa-li"><i class="fa fa-leaf"></i></span>
                        We didn't have enough confidence with MongoDB...
                    </li>
                </ul>
                <aside class="notes">
                    <strong style="font-size: larger">16:10</strong>
                    <ul>
                        <li>
                            We easily identified the points where we needed to store events
                        </li>
                    </ul>
                </aside>
            </section>
            <section>
                <h2>Real-time (delayed) storing</h2>
                <ul class="fa-ul">
                    <li>
                        <span class="fa-li"><i class="fa fa-hourglass-half"></i></span>
                        ... so we used our (RabbitMQ) queue
                    </li>
                </ul>
                <aside class="notes">
                    <ul>
                        <li>
                            (RabbitMQ) queue to delay the event storing
                            and avoid failures in critical processes
                        </li>
                        <li>
                            In theory, events should be append only,<br>
                            immutable and ordered in time...
                        </li>
                        <li>
                            We made this exception as an intentional trade-off
                        </li>
                    </ul>
                </aside>
            </section>
            <section>
                <h2>Generating events for the past</h2>
                <ul class="fa-ul">
                    <li>
                        <span class="fa-li"><i class="fa fa-history"></i></span>
                        The trade-off allowed us to easily back-fill events
                    </li>
                </ul>
                <aside class="notes">
                    <ul>
                        <li>
                            In theory, you shouldn't do it...
                        </li>
                        <li>
                            We needed them for renewals (-1 year in the past)
                        </li>
                        <li>
                            We had to avoid writing duplicates
                        </li>
                        <li>
                            Deriving events from the current (lossy) state
                        </li>
                    </ul>
                </aside>
                <!--<p>example: RinnovvoDiary needed +12months from event origin</p>-->
                <!--<p>What's the correct created at? You're reading current state</p>-->
            </section>
        </section>
        <section id="event-sourcing">
            <section>
                <h2>It's time to read!</h2>
                <aside class="notes">
                    <strong style="font-size: larger">21:34</strong>
                </aside>
            </section>
            <section>
                <h2>Projections</h2>
                <ul class="fa-ul">
                    <li>
                        <span class="fa-li"><i class="fa fa-window-restore"></i></span>
                        Aggregated result of multiple events
                    </li>
                    <li>
                        <span class="fa-li"><i class="fa fa-step-forward"></i></span>
                        They are produced replaying events one at a time,<br>
                        and using them to reconstruct the desired result
                    </li>
                </ul>
            </section>
            <section>
                <h2>Our implementation</h2>
                <table class="stretch">
                    <thead>
                    <tr>
                        <th width="50%">Classes</th>
                        <th width="50%">Documents</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td>
                            <ol>
                                <li><code>Runner</code>
                                <li><code>Projectors</code>
                                <li><code>Executors</code></li>
                            </ol>
                        </td>
                        <td style="vertical-align: top">
                            <ol>
                                <li><code>RunState</code></li>
                                <li><code>ProjectionState</code></li>
                            </ol>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </section>
            <section>
                <h2>The (one and only) Runner</h2>
                <pre><code data-trim data-noescape>
class Runner
{
    public function run(ProjectorInterface $projector);
}					
                </code></pre>
                <aside class="notes">
                    <ul>
                        <li>
                            Started by a SF Console command
                        </li>
                        <li>
                            Handles the cycle, one event at a time
                        </li>
                        <li>
                            Handles event filters provided by the <code>Projector</code>
                        </li>
                        <li>
                            Iterates through the events, one at a time
                        </li>
                    </ul>
                </aside>
            </section>
            <section>
                <h2>The RunState document</h2>
                <p>Used by the runner to persist execution state</p>
                <pre class="stretch"><code data-trim data-noescape>
class RunState implements MongoDocumentInterface
{
    /** @var string The Projector FQCN */
    private $class; 

    /** @var bool */
    private $stillRunning;
    /** @var \DateTimeInterface */
    private $lastRunAt;

    /** @var Mongo\ObjectId */
    private $lastMaxId;
    /** @var \DateTimeInterface */
    private $lastProjectedEventCreatedAt;
}
						</code></pre>
            </section>
            <section>
                <h2>The Projectors</h2>
                <pre style="width: 100%"><code data-trim data-noescape>
interface ProjectorInterface
{
     // projection execution
    public function initializeProjector();

    public function projectAndSave(Event $event): Result;

    public function normalizeAfterRun(\DateTime $from, \DateTime $to);

    // event filters
    public function getEventTypes(): array;

    public function getAdditionalEventFilters(): array;
}
						</code></pre>
            </section>
            <section>
                <div>
                    <code>Runner::run()</code><br>
                    <small>Pre-execution checks</small>
                </div>
                <pre class="stretch"><code data-trim data-noescape>
$runState = $this->loadRunState($projector);
$iterator = $this->loadIterator($runState, $projector);
$event = $iterator->rewind();

if (! $iterator->valid()) {
    return $this->updateRunStateOnAccomplished($runState, $lastEvent);
}

if ($this->isInvalidRun($runState, $event)) {
    $runState->setLastProjectedCreateAt($event->getCreatedAt());
    $runState->setStopped(true);
    $this->persistanceManager->save($runState);

    return $this->run($projector);
}

$this->updateRunStateOnStarted($runState);

// ...
                        </code></pre>
            </section>
            <section>
                <div>
                    <code>Runner::run()</code><br>
                    <small>The loop</small>
                </div>
                <pre class="stretch"><code data-trim data-noescape>
do {
    $lastEvent = $iterator->current();

    $projector->projectAndSave($lastEvent);

    if ($this->shouldStop($start, $projector)) {
        $this->updateRunStateOnStopped($runState, $lastEvent);

        break;
    }

} while ($iterator->next());

$projector->normalizeAfterRun(
    $firstEvent->getCreatedAt(), 
    $lastEvent->getCreatedAt()
);

$this->updateRunStateOnAccomplished($runState, $maxId, $lastCreatedAt);
						</code></pre>
            </section>
            <section>
                <h2>The executors</h2>
                <p>
                    The Projector delegates the calculations<br>
                    to a group of <code>Executor</code> classes
                </p>
                <pre><code data-trim data-noescape>
interface ExecutorInterface
{
    public function supportEventsType(): array;

    public function execute(Event $event): Result;
}
                        </code></pre>
                <pre><code data-trim data-noescape>
class SomeProjector implements ProjectorInterface
{
    public function projectAndSave(Event $event): Result
    {
        return $this->getExecutor($event)->execute($event);
    }
}
                        </code></pre>
            </section>
            <section>
                <h2>Intermediate state and correlation</h2>
                <ul class="fa-ul">
                    <li>
                        <span class="fa-li"><i class="fa fa-random"></i></span>
                        Executors must be idempotent
                    </li>
                    <li>
                        <span class="fa-li"><i class="fa fa-file-alt"></i></span>
                        <code>ProjectionState</code> stores additional information
                    </li>
                </ul>
                <pre><code data-trim data-noescape>
class ProjectionState implements MongoDocumentInterface
{
    /** @var string The Projector FQCN */
    private $class;

    /** @var string */
    private $correlationId;

    /** @var mixed */
    private $data;

    /** @var \DateTime|null */
    private $expireAt;
}
                        </code></pre>
                <aside class="notes">
                    <p>i.e. if a bug produces a duplicated event, we must handle it gracefully</p>
                    <p>example: Renewals/product selling not expected</p>
                </aside>
            </section>
            <section>
                <h2>Reducing the amount of data</h2>
                <ul class="fa-ul">
                    <li>
                        <span class="fa-li"><i class="fa fa-trash-alt"></i></span>
                        Delete <code>ProjectionState</code> ASAP
                    </li>
                    <li>
                        <span class="fa-li"><i class="fa fa-trash-alt"></i></span>
                        <code>ProjectionStates::$expirationDate</code><br>
                        makes data disappear
                    </li>
                    <pre><code data-trim data-noescape>
db.projection_state.createIndex(
    { "expireAt": 1 },
    { expireAfterSeconds: 0 }
);</code></pre>
                </ul>
                <aside class="notes">
                    <p>Any document adds to the performance toll</p>
                </aside>
            </section>
            <section>
                <h2>The real trick: pushing state away</h2>
                <ul class="fa-ul">
                    <li>
                        <span class="fa-li"><i class="fa fa-thumbs-up"></i></span>
                        Every class is stateless:<br>
                        no properties contain data, only dependencies
                    </li>
                    <li>
                        <span class="fa-li"><i class="fa fa-database"></i></span>
                        When we have state<br>
                        <small style="display: block">
                            (<code>RunState</code>, <code>ProjectionState</code>, the projection itself)
                        </small>
                        we save it as documents on MongoDB
                    </li>
                </ul>
            </section>
        </section>
        <section id="practical-issues">
            <section>
                <h2>Practical issues</h2>
            </section>
            <section>
                <h2>The runner</h2>
                <ul class="fa-ul">
                    <li>
                        <span class="fa-li"><i class="fa fa-signal"></i></span>
                        Events can only increase
                        <small style="display: block">We started at 1.8M, we're now reaching 35M events</small>
                    </li>
                    <li>
                        <span class="fa-li"><i class="fa fa-hourglass-half"></i></span>
                        Long running processes
                    </li>
                    <li>&nbsp;</li>
                    <li>
                        <span class="fa-li"><i class="fa fa-rocket"></i></span>
                        Fix: short burst executions
                    </li>
                </ul>
                <aside class="notes">
                    <strong style="font-size: larger">33:18</strong>
                    <ul>
                        <li>
                        Since events' collection grows really fast,<br>
                        projections can take a very long time to complete from the beginning
                    </li>
                    <li>
                        We found multiple memory leaks (<code>gc_collect_cycles</code> , <code>ext-mongodb</code>)
                    </li>
                    <li>
                        We check if an other instance of the projector is already running<br>
                        <small>We use the Symfony's <code>LockableTrait</code></small>
                    </li>
                </ul>
                </aside>
            </section>
            <section>
                <h2>Updating past events</h2>
                <ul class="fa-ul">
                    <li>
                        <span class="fa-li"><i class="fa fa-exclamation-triangle"></i></span>
                        We forgot to add some payload data...
                    </li>
                    <li>
                        <span class="fa-li"><i class="fa fa-lightbulb"></i></span>
                        Fix: The trade-off paid again
                    </li>
                    <li>
                        &nbsp;
                    </li>
                    <li>
                        <span class="fa-li"><i class="fa fa-clock"></i></span>
                        Report outages during rewrites
                    </li>
                    <li>
                        <span class="fa-li"><i class="fa fa-camera-retro"></i></span>
                        Fix: snapshots
                    </li>
                </ul>
                <aside class="notes">
                    <ul>
                        <li>
                            Especially early in the development phase,<br>
                            we forgot to add some payload data...
                        </li>
                        <li>
                            Since we did that trade-off to start with,<br>
                            we were able to fix it
                        </li>
                        <li>
                            Solution: fix code + fix events + reset projection
                        </li>
                    </ul>
                </aside>
            </section>
            <section>
                <h2>Projections and code reuse</h2>
                <ul class="fa-ul">
                    <li>
                        <span class="fa-li"><i class="fa fa-biohazard"></i></span>
                        Tempting to reuse <code>Executors</code> code...
                    </li>
                </ul>
            </section>
            <aside class="notes">
                <p>
                    Due to CQRS and our objects' architecture,<br>
                    reusing code between projections is impractical
                </p>
            </aside>
        </section>
        <section id="advantages">
            <section>
                <h2>What we gained</h2>
                <aside class="notes">
                    <strong style="font-size: larger">36:32</strong>
                </aside>
            </section>
            <section>
                <h2>We reached our goal!!!</h2>
                <ul class="fa-ul">
                    <li>
                        <span class="fa-li"><i class="fa fa-chart-line"></i></span>
                        New complex reports
                    </li>
                    <li>
                        <span class="fa-li"><i class="fa fa-leaf"></i></span>
                        MongoDB
                    </li>
                </ul>
                <aside class="notes">
                    <p>
                        We obtained an easy way to produce <br>
                        new complex reports with historical reliability
                    </p>
                </aside>
            </section>
            <section>
                <h2>Projection reuse</h2>
                <p>
                    Events
                    <i class="fa fa-arrow-right"></i>
                    <span class="black-box">Projector</span>
                    <i class="fa fa-arrow-right"></i>
                    Projection (intermediate)
                </p>
                <p>
                    Projection
                    <i class="fa fa-arrow-right"></i>
                    <span class="black-box"><i class="fa fa-leaf"></i> aggregation</span>
                    <i class="fa fa-arrow-right"></i>
                    Final result (snapshot)
                </p>
                <aside class="notes">
                    A projector can produce an intermediate result:<br>
                    a simple denormalization that can be easily queried
                </aside>
            </section>
            <section style="text-align: center">
                <h2>Complexity split</h2>
                <p>Small context, easily testable</p>
                <table id="schema-table">
                    <tbody>
                    <tr>
                        <td colspan="3"><span class="black-box">Runner</span></td>
                    </tr>
                    <tr class="fa-2x">
                        <td style="text-align: right">
                            <i class="fa fa-arrow-down fa-lg" data-fa-transform="rotate-45"></i>
                        </td>
                        <td>
                            <i class="fa fa-arrow-down fa-lg"></i>
                        </td>
                        <td style="text-align: left">
                            <i class="fa fa-arrow-down fa-lg" data-fa-transform="rotate--45"></i>
                        </td>
                    </tr>
                    <tr>
                        <td><span class="black-box">Projector1</span></td>
                        <td><span class="black-box">Projector2</span></td>
                        <td><span class="black-box">Projector3</span></td>
                    </tr>
                    <tr>
                        <td><i class="fa fa-arrow-down"></i></td>
                        <td><i class="fa fa-arrow-down"></i></td>
                        <td><i class="fa fa-arrow-down"></i></td>
                    </tr>
                    <tr class="smaller">
                        <td><span class="black-box">Executor1a</span></td>
                        <td><span class="black-box">Executor2a</span></td>
                        <td><span class="black-box">Executor3a</span></td>
                    </tr>
                    <tr class="smaller">
                        <td><span class="black-box">Executor1b</span></td>
                        <td><span class="black-box">Executor2b</span></td>
                        <td><span class="black-box">Executor3b</span></td>
                    </tr>
                    <tr class="smaller">
                        <td><span class="black-box">...</span></td>
                        <td><span class="black-box">...</span></td>
                        <td><span class="black-box">...</span></td>
                    </tr>
                    </tbody>
                </table>
            </section>
            <section>
                <h2>Debug superpowers</h2>
                <p>Since we have events, we know EVERYTHING</p>
                <p>
                    Investigating a strange bug report <br>
                    is now easier than ever
                </p>
            </section>
            <section>
                <h2>Our Symfony bundle</h2>
                <ul class="fa-ul">
                    <li>
                        <span class="fa-li"><i class="fab fa-github"></i></span>
                        <a href="https://github.com/facile-it/mongodb-bundle">
                            <code>facile-it/mongodb-bundle</code>
                        </a>
                    </li>
                    <li>
                        <span class="fa-li"><i class="fa fa-database"></i></span>
                        Barebone integration with <code>ext-mongodb</code>
                    </li>
                    <li>
                        <span class="fa-li"><i class="far fa-window-maximize"></i></span>
                        Nice profile addon<br>
                        <img src="img/mongodb-bundle.png">
                    </li>
                </ul>
            </section>
        </section>

        <section id="ending">
            <section>
                <h2>Thanks!</h2>
                <h4>Contacts</h4>
                <div style="font-size: smaller">
                    <ul class="fa-ul">
                        <li>
                            <span class="fa-li"><i class="fas fa-envelope"></i></span>
                            <a href="mailto:alessandro.lai85@gmail.com">alessandro.lai85@gmail.com</a>
                        </li>
                        <li>
                            <span class="fa-li"><i class="fas fa-envelope"></i></span>
                            <a href="mailto:alessandro.lai@facile.it">alessandro.lai@facile.it</a>
                            <small style="vertical-align: middle">(we are hiring!)</small>
                        </li>
                        <li>
                            <span class="fa-li"><i class="fab fa-github"></i></span>
                            <a href="https://github.com/Jean85">@Jean85</a>
                        </li>
                        <li>
                            <span class="fa-li"><i class="fab fa-twitter"></i></span>
                            <a href="https://twitter.com/AlessandroLai">@AlessandroLai</a>
                        </li>
                    </ul>
                </div>
                <div>
                    <h6>Attributions</h6>
                    <small>
                        <ul class="fa-ul">
                            <li>
                                <span class="fa-li"><i class="fas fa-image"></i></span>
                                <a title="money" href="https://flickr.com/photos/khrawlings/3407402643">money</a>,
                                flickr photo by
                                <a href="https://flickr.com/people/khrawlings">khrawlings</a>
                                shared under a
                                <a href="https://creativecommons.org/licenses/by-nc/2.0/">Creative Commons (BY-NC)
                                    license</a>
                            </li>
                            <li>
                                <span class="fa-li"><i class="fas fa-image"></i></span>
                                <a title="Going to a movie that Doug chose - one of the Little Things....."
                                   href="https://flickr.com/photos/75885098@N05/33139557886">
                                    Going to a movie that Doug chose - one of the Little Things.....</a>,
                                flickr photo by
                                <a href="https://flickr.com/people/75885098@N05">Bennilover</a>
                                shared under a
                                <a href="https://creativecommons.org/licenses/by-nd/2.0/">Creative Commons (BY-ND)
                                    license</a>
                            </li>
                            <li>
                                <span class="fa-li"><i class="fas fa-image"></i></span>
                                <a title="window2"
                                   href="https://flickr.com/photos/132178549@N08/17013750711">window2</a>,
                                flickr photo by
                                <a href="https://flickr.com/people/132178549@N08">Pascale Doria</a>
                                shared under a
                                <a href="https://creativecommons.org/licenses/by/2.0/">Creative Commons (BY) license</a>
                            </li>
                            <li>
                                <span class="fa-li"><i class="fas fa-image"></i></span>
                                <a title="mess" href="https://flickr.com/photos/ilovehappy/606583152">mess</a>,
                                flickr photo by
                                <a href="https://flickr.com/people/ilovehappy">i ♥ happy!!</a>
                                shared under a
                                <a href="https://creativecommons.org/licenses/by/2.0/">Creative Commons (BY) license</a>
                            </li>
                        </ul>
                    </small>
                </div>
            </section>
            <section>
                <h2>Additional references</h2>
                <ul class="fa-ul">
                    <li>
                        <span class="fa-li"><i class="fab fa-youtube"></i></span>
                        <a href="https://www.youtube.com/watch?v=8JKjvY4etTY">
                            Greg Young - Event Sourcing
                        </a><br>
                        <small>Talk - GOTO 2014 conference</small>
                    </li>
                    <li>
                        <span class="fa-li"><i class="fab fa-youtube"></i></span>
                        <a href="https://www.youtube.com/watch?v=2nDNMB_wXcE">
                            Mathias Verraes - Messages over Structure
                        </a><br>
                        <small>Keynote - Neos 2017 conference</small>
                    </li>
                    <li>
                        <span class="fa-li"><i class="fab fa-youtube"></i></span>
                        <a href="https://www.youtube.com/watch?v=STKCRSUsyP0">
                            Martin Fowler - The Many Meanings of Event-Driven Architecture
                        </a><br>
                        <small>Keynote - GOTO 2017 conference</small>
                    </li>
                    <li>
                        <span class="fa-li"><i class="fab fa-youtube"></i></span>
                        <a href="https://www.youtube.com/watch?v=RfnySciLUhc">
                            Marco Pivetta - Basic CQRS and Event Sourcing with Prooph
                        </a><br>
                        <small>Workshop - WebSC 2017</small>
                    </li>
                </ul>
            </section>
            <section>
                <h2>Questions?</h2>
            </section>
        </section>
    </div>
</div>

<script src="js/reveal.js"></script>

<script>
    // More info about config & dependencies:
    // - https://github.com/hakimel/reveal.js#configuration
    // - https://github.com/hakimel/reveal.js#dependencies
    Reveal.initialize({
        history: true,
        keyboard: {
            38: 'prev', // go to the prev slide/fragment when the UP key is pressed
            40: 'next', // go to the next slide/fragment when the DOWN key is pressed
        },
        dependencies: [
            {src: 'plugin/zoom-js/zoom.js', async: true},
            {src: 'plugin/markdown/marked.js'},
            {src: 'plugin/markdown/markdown.js'},
            {src: 'plugin/notes/notes.js', async: true},
            {src: 'plugin/highlight/highlight.js', async: true}
        ]
    });
</script>
</body>
</html>
